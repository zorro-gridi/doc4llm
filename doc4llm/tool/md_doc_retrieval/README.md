# Markdown Document Retrieval

A sub-package for retrieving content from markdown documents stored in the `md_docs` directory structure generated by doc4llm.

> **Note:** This package was previously named `md_doc_extractor` and was renamed to `md_doc_retrieval` in v3.0.0 to better reflect its comprehensive functionality including extraction, matching, query optimization, chain reasoning, and conversation memory. A compatibility layer is available at `md_doc_extractor` for backward compatibility.

## Overview

The `md_doc_retrieval` sub-package provides tools for:

- Extracting content from markdown documents by title
- **Single file mode** - directly extract content from a single `.md` file
- Multiple search modes (exact, case-insensitive, fuzzy, partial)
- Document structure parsing and validation
- Utility functions for path building and similarity calculation
- **Basic matcher** (`BasicDocMatcher`) - foundational matching without LLM dependency
- **Agentic matcher** (`AgenticDocMatcher`) - multi-stage progressive retrieval with re-ranking
- **Hybrid matcher** (`HybridMatcher`) - fast rule-based with LLM fallback
- **Chain reasoner** (`ChainReasoner`) - multi-hop reasoning for complex queries
- **Conversation memory** (`ConversationMemory`) - persistent context-aware queries

## Directory Structure

The expected documentation directory structure is:

```
md_docs/
└── <doc_name>@<doc_version>/
    └── <PageTitle>/
        └── docContent.md
```

Example:
```
md_docs/
└── code_claude_com@latest/
    ├── Agent Skills - Claude Code Docs/
    │   └── docContent.md
    └── Slash Commands/
        └── docContent.md
```

## Installation

This module is part of the doc4llm package. No additional installation is required.

```bash
pip install doc4llm
```

## Quick Start

### Directory Mode (default)

```python
# Import the main extractor class
from doc4llm.tool.md_doc_retrieval import MarkdownDocExtractor

# Create an extractor instance
extractor = MarkdownDocExtractor()

# Extract content by exact title
content = extractor.extract_by_title("Agent Skills - Claude Code Docs")
print(content[:100])  # Print first 100 characters
```

### Single File Mode

```python
# Create an extractor for a single file
extractor = MarkdownDocExtractor(single_file_path="/path/to/file.md")

# Direct read - returns the entire file content
content = extractor.extract_by_title()

# Title matching - returns content only if title matches
content = extractor.extract_by_title("Agent Skills")  # Matches or returns ""
```

### Using BasicDocMatcher Directly

```python
from doc4llm.tool.md_doc_retrieval import BasicDocMatcher

# Create a matcher with specific configuration
matcher = BasicDocMatcher(
    search_mode="exact",
    case_sensitive=False,
    fuzzy_threshold=0.6
)

# Match a title against available titles
result = matcher.match("agent skills", ["Agent Skills", "Slash Commands"])
if result:
    print(f"Matched: {result.title} (similarity: {result.similarity})")
```

## API Reference

### `MarkdownDocExtractor`

The main class for extracting markdown document content.

#### Constructor Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `base_dir` | `str \| None` | `"md_docs"` | Base documentation directory path |
| `single_file_path` | `str \| None` | `None` | Path to a single `.md` file for single-file mode |
| `search_mode` | `str` | `"exact"` | Search mode: `"exact"`, `"case_insensitive"`, `"fuzzy"`, or `"partial"` |
| `case_sensitive` | `bool` | `False` | Whether exact matching is case sensitive |
| `max_results` | `int \| None` | `None` | Maximum results for fuzzy/partial searches |
| `fuzzy_threshold` | `float` | `0.6` | Minimum similarity ratio (0.0-1.0) for fuzzy matching |
| `debug_mode` | `bool` | `False` | Enable debug output |
| `enable_fallback` | `bool` | `False` | Enable automatic fallback to other search modes on failure |
| `fallback_modes` | `List[str] \| None` | `["case_insensitive", "partial", "fuzzy"]` | Search modes to try as fallback |
| `compress_threshold` | `int` | `1000` | Line count threshold for content compression |
| `enable_compression` | `bool` | `False` | Enable automatic content compression for large documents |

#### Methods

##### `extract_by_title(title: str | None = None) -> str | None | ""`

Extract content for a single document title.

**Directory mode**: Returns content or `None` if not found.
**Single file mode**: Returns content, `""` if title doesn't match, or full content if `title` is `None`.

```python
# Directory mode
extractor = MarkdownDocExtractor()
content = extractor.extract_by_title("Agent Skills - Claude Code Docs")
if content:
    print(f"Extracted {len(content)} characters")

# Single file mode - direct read
extractor = MarkdownDocExtractor(single_file_path="/path/to/file.md")
content = extractor.extract_by_title()  # Returns full content

# Single file mode - with title matching
content = extractor.extract_by_title("Agent Skills")
if content:  # Check if not empty string
    print(f"Matched! Extracted {len(content)} characters")
```

##### `extract_by_titles(titles: List[str]) -> Dict[str, str]`

Extract content for multiple document titles.

```python
results = extractor.extract_by_titles([
    "Agent Skills - Claude Code Docs",
    "Slash Commands"
])
for title, content in results.items():
    print(f"{title}: {len(content)} characters")
```

##### `extract_by_titles_with_metadata(titles: List[str], threshold: int = 2100) -> ExtractionResult`

Extract multiple documents with complete metadata including line counts.

```python
result = extractor.extract_by_titles_with_metadata([
    "Hooks reference",
    "Deployment guide"
])

if result.requires_processing:
    print(f"Need to process: {result.total_line_count} lines")
else:
    print(f"Within threshold: {result.total_line_count} lines")

# Print summary
print(result.to_summary())
```

##### `search_documents(title: str) -> List[Dict[str, Any]]`

Search for documents matching a title pattern. Returns detailed information including similarity scores.

```python
extractor = MarkdownDocExtractor(search_mode="fuzzy")
results = extractor.search_documents("agent skills")
for result in results:
    print(f"{result['title']} (similarity: {result['similarity']:.2f})")
```

##### `semantic_search_titles(query: str, doc_set: str | None = None, max_results: int = 10) -> List[Dict[str, Any]]`

Multi-strategy semantic search combining exact, partial, and fuzzy matching.

```python
results = extractor.semantic_search_titles("skill", max_results=5)
for result in results:
    print(f"{result['title']} - {result['match_type']} ({result['similarity']})")
```

### `BasicDocMatcher`

Foundational matcher class without LLM dependency.

#### Constructor Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `search_mode` | `str` | `"exact"` | Search mode: `"exact"`, `"case_insensitive"`, `"fuzzy"`, or `"partial"` |
| `case_sensitive` | `bool` | `False` | Whether exact matching is case sensitive |
| `fuzzy_threshold` | `float` | `0.6` | Minimum similarity for fuzzy matching (0.0-1.0) |
| `max_results` | `int \| None` | `None` | Maximum results to return for fuzzy/partial searches |

#### Methods

##### `match(title: str, titles: List[str], mode: str | None = None) -> MatchResult | None`

Match a title using the configured strategy.

```python
matcher = BasicDocMatcher(search_mode="exact")
result = matcher.match("Agent Skills", ["Agent Skills", "Slash Commands"])
if result:
    print(f"{result.title}: {result.match_type} ({result.similarity})")
```

##### `find_exact_match(title: str, titles: List[str]) -> str | None`

Find an exact title match.

##### `find_partial_match(title: str, titles: List[str]) -> List[str]`

Find all partial (substring) matches.

##### `find_fuzzy_match(title: str, titles: List[str]) -> Tuple[str, float] | None`

Find the best fuzzy match using similarity scoring.

##### `semantic_search(query: str, titles_with_doc: List[Tuple[str, str]]) -> List[MatchResult]`

Multi-strategy semantic search.

## Search Modes

### `exact` (default)

Requires exact title match. Case sensitivity controlled by `case_sensitive` parameter.

```python
extractor = MarkdownDocExtractor(search_mode="exact", case_sensitive=False)
```

### `case_insensitive`

Case-insensitive exact match (equivalent to `exact` with `case_sensitive=False`).

```python
extractor = MarkdownDocExtractor(search_mode="case_insensitive")
```

### `fuzzy`

Uses fuzzy string matching with similarity scoring. Matches above `fuzzy_threshold` are returned.

```python
extractor = MarkdownDocExtractor(search_mode="fuzzy", fuzzy_threshold=0.6)
```

### `partial`

Matches titles containing the query as a substring.

```python
extractor = MarkdownDocExtractor(search_mode="partial")
```

## Import Options

### Import from new package (recommended):

```python
from doc4llm.tool.md_doc_retrieval import (
    MarkdownDocExtractor,
    BasicDocMatcher,
    ExtractionResult,
)
```

### Import from old package (compatibility layer, shows deprecation warning):

```python
from doc4llm.tool.md_doc_extractor import MarkdownDocExtractor
# Shows deprecation warning but works
```

### Import from parent package:

```python
from doc4llm.tool import MarkdownDocExtractor, BasicDocMatcher
```

## Migration from `md_doc_extractor`

If you're using the old `md_doc_extractor` package name:

```python
# Old (deprecated, will show warning)
from doc4llm.tool.md_doc_extractor import MarkdownDocExtractor

# New (recommended)
from doc4llm.tool.md_doc_retrieval import MarkdownDocExtractor
```

The old package name will continue to work through a compatibility layer, but a deprecation warning will be shown.

## Version History

- **v3.0.0**: Package renamed to `md_doc_retrieval`, added `BasicDocMatcher` class
- **v2.6.0**: Added `SearchHelpers` class
- **v2.5.0**: Added `ExtractionResult` with metadata tracking
- **v2.4.0**: Added conversation memory support
- **v2.3.0**: Added chain reasoner for multi-hop reasoning
- **v2.2.0**: Added query optimizer
- **v2.1.0**: Added hybrid matcher with LLM enhancement
- **v2.0.0**: Added agentic matcher with progressive retrieval
- **v1.0.0**: Initial release

## Current Version

`3.0.0`
