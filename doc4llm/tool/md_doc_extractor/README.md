# Markdown Document Extractor

A sub-package for extracting content from markdown documents stored in the `md_docs` directory structure generated by doc4llm.

## Overview

The `md_doc_extractor` sub-package provides tools for:

- Extracting content from markdown documents by title
- **Single file mode** - directly extract content from a single `.md` file
- Multiple search modes (exact, case-insensitive, fuzzy, partial)
- Document structure parsing and validation
- Utility functions for path building and similarity calculation

## Directory Structure

The expected documentation directory structure is:

```
md_docs/
└── <doc_name>:<doc_version>/
    └── <PageTitle>/
        └── docContent.md
```

Example:
```
md_docs/
└── code_claude_com:latest/
    ├── Agent Skills - Claude Code Docs/
    │   └── docContent.md
    └── Slash Commands/
        └── docContent.md
```

## Installation

This module is part of the doc4llm package. No additional installation is required.

```bash
pip install doc4llm
```

## Quick Start

### Directory Mode (default)

```python
# Import the main extractor class
from doc4llm.tool.md_doc_extractor import MarkdownDocExtractor

# Create an extractor instance
extractor = MarkdownDocExtractor()

# Extract content by exact title
content = extractor.extract_by_title("Agent Skills - Claude Code Docs")
print(content[:100])  # Print first 100 characters
```

### Single File Mode

```python
# Create an extractor for a single file
extractor = MarkdownDocExtractor(single_file_path="/path/to/file.md")

# Direct read - returns the entire file content
content = extractor.extract_by_title()

# Title matching - returns content only if title matches
content = extractor.extract_by_title("Agent Skills")  # Matches or returns ""
```

## API Reference

### `MarkdownDocExtractor`

The main class for extracting markdown document content.

#### Constructor Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `base_dir` | `str \| None` | `"md_docs"` | Base documentation directory path |
| `single_file_path` | `str \| None` | `None` | Path to a single `.md` file for single-file mode |
| `search_mode` | `str` | `"exact"` | Search mode: `"exact"`, `"case_insensitive"`, `"fuzzy"`, or `"partial"` |
| `case_sensitive` | `bool` | `False` | Whether exact matching is case sensitive |
| `max_results` | `int \| None` | `None` | Maximum results for fuzzy/partial searches |
| `fuzzy_threshold` | `float` | `0.6` | Minimum similarity ratio (0.0-1.0) for fuzzy matching |
| `debug_mode` | `bool` | `False` | Enable debug output |

#### Methods

##### `extract_by_title(title: str | None = None) -> str | None | ""`

Extract content for a single document title.

**Directory mode**: Returns content or `None` if not found.
**Single file mode**: Returns content, `""` if title doesn't match, or full content if `title` is `None`.

```python
# Directory mode
extractor = MarkdownDocExtractor()
content = extractor.extract_by_title("Agent Skills - Claude Code Docs")
if content:
    print(f"Extracted {len(content)} characters")

# Single file mode - direct read
extractor = MarkdownDocExtractor(single_file_path="/path/to/file.md")
content = extractor.extract_by_title()  # Returns full content

# Single file mode - with title matching
content = extractor.extract_by_title("Agent Skills")
if content:  # Check if not empty string
    print(f"Matched! Extracted {len(content)} characters")
```

##### `extract_by_titles(titles: List[str]) -> Dict[str, str]`

Extract content for multiple document titles.

```python
results = extractor.extract_by_titles([
    "Agent Skills - Claude Code Docs",
    "Slash Commands"
])
for title, content in results.items():
    print(f"{title}: {len(content)} characters")
```

##### `search_documents(title: str) -> List[Dict[str, Any]]`

Search for documents matching a title pattern. Returns detailed information including similarity scores.

```python
extractor = MarkdownDocExtractor(search_mode="fuzzy")
results = extractor.search_documents("agent skills")
for result in results:
    print(f"{result['title']} (similarity: {result['similarity']:.2f})")
```

Returns a list of dictionaries with keys:
- `title`: Matched document title
- `similarity`: Similarity score (0.0-1.0)
- `doc_name_version`: Document name and version (e.g., `"code_claude_com:latest"`)

##### `list_available_documents(doc_name_version: str | None = None) -> List[str]`

List all available document titles.

```python
# List all documents
all_docs = extractor.list_available_documents()

# List documents from a specific source
claude_docs = extractor.list_available_documents("code_claude_com:latest")
```

##### `get_document_info(title: str) -> Dict[str, Any] | None`

Get detailed information about a document.

```python
info = extractor.get_document_info("Agent Skills - Claude Code Docs")
if info:
    print(f"Path: {info['path']}")
    print(f"Size: {info['size']} bytes")
    print(f"Exists: {info['exists']}")
```

Returns a dictionary with keys:
- `title`: Document title
- `doc_name_version`: Document name and version
- `path`: Full path to `docContent.md`
- `exists`: Whether the file exists
- `size`: File size in bytes (if exists)

##### `from_config(config_path: str | None = None) -> MarkdownDocExtractor`

Create an extractor instance from a configuration file.

```python
# Load from default config location
extractor = MarkdownDocExtractor.from_config()

# Load from custom path
extractor = MarkdownDocExtractor.from_config("path/to/config.json")
```

Default config location: `doc4llm/config/config.json`

Config structure:
```json
{
  "tool": {
    "markdown_extractor": {
      "base_dir": "md_docs",
      "default_search_mode": "exact",
      "case_sensitive": false,
      "max_results": 10,
      "fuzzy_threshold": 0.6
    }
  },
  "debug_mode": 0
}
```

## Search Modes

### `exact` (default)

Requires exact title match. Case sensitivity controlled by `case_sensitive` parameter.

```python
extractor = MarkdownDocExtractor(search_mode="exact", case_sensitive=False)
```

### `case_insensitive`

Case-insensitive exact match (equivalent to `exact` with `case_sensitive=False`).

```python
extractor = MarkdownDocExtractor(search_mode="case_insensitive")
```

### `fuzzy`

Uses fuzzy string matching with similarity scoring. Matches above `fuzzy_threshold` are returned.

```python
extractor = MarkdownDocExtractor(search_mode="fuzzy", fuzzy_threshold=0.6)
```

### `partial`

Matches titles containing the query as a substring.

```python
extractor = MarkdownDocExtractor(search_mode="partial")
```

## Utility Functions

The following utility functions are also available for direct use:

### `normalize_title(title: str) -> str`

Normalize a document title for consistent matching.

```python
from doc4llm.tool.md_doc_extractor import normalize_title

normalized = normalize_title("  Agent   Skills  ")
# Returns: "Agent Skills"
```

### `calculate_similarity(str1: str, str2: str) -> float`

Calculate string similarity using `difflib.SequenceMatcher`. Returns a value between 0.0 and 1.0.

```python
from doc4llm.tool.md_doc_extractor import calculate_similarity

score = calculate_similarity("hello", "hallo")
# Returns: 0.8
```

### `build_doc_path(base_dir: str, doc_name: str, doc_version: str, title: str) -> str`

Build the full path to a document's `docContent.md` file.

```python
from doc4llm.tool.md_doc_extractor import build_doc_path

path = build_doc_path("md_docs", "code_claude_com", "latest", "Skills")
# Returns: "md_docs/code_claude_com:latest/Skills/docContent.md"
```

### `parse_doc_structure(base_dir: str) -> Dict[str, List[str]]`

Parse the documentation directory structure.

```python
from doc4llm.tool.md_doc_extractor import parse_doc_structure

structure = parse_doc_structure("md_docs")
# Returns: {"code_claude_com:latest": ["Agent Skills", "Slash Commands"]}
```

### `find_best_match(query: str, candidates: List[str], threshold: float = 0.6) -> Tuple[str, float] | None`

Find the best matching candidate using fuzzy string matching.

```python
from doc4llm.tool.md_doc_extractor import find_best_match

result = find_best_match("agent skills", ["Agent Skills", "Slash Commands"])
# Returns: ("Agent Skills", 1.0)
```

### `sanitize_filename(filename: str) -> str`

Sanitize a filename by removing invalid characters.

```python
from doc4llm.tool.md_doc_extractor import sanitize_filename

clean = sanitize_filename("file/name?.txt")
# Returns: "filename.txt"
```

### `is_valid_doc_directory(path: str) -> bool`

Check if a directory is a valid document directory (contains `docContent.md`).

```python
from doc4llm.tool.md_doc_extractor import is_valid_doc_directory

valid = is_valid_doc_directory("md_docs/code_claude_com:latest/Skills")
# Returns: True if docContent.md exists
```

### `extract_doc_name_and_version(doc_dir: str) -> Tuple[str, str]`

Extract document name and version from a directory string.

```python
from doc4llm.tool.md_doc_extractor import extract_doc_name_and_version

name, version = extract_doc_name_and_version("code_claude_com:latest")
# Returns: ("code_claude_com", "latest")
```

### `extract_title_from_md_file(file_path: str) -> str`

Extract title from a Markdown file by reading the first heading.

```python
from doc4llm.tool.md_doc_extractor import extract_title_from_md_file

title = extract_title_from_md_file("/path/to/file.md")
# Returns: "Agent Skills" (or similar heading from the file)
```

## Exceptions

All exceptions inherit from `DocExtractorError`:

| Exception | Description |
|-----------|-------------|
| `DocumentNotFoundError` | Document file cannot be found |
| `InvalidTitleError` | Title is invalid or cannot be processed |
| `BaseDirectoryNotFoundError` | Documentation base directory does not exist |
| `NoDocumentsFoundError` | No documents found in the structure |
| `ConfigurationError` | Configuration-related error |
| `SingleFileNotFoundError` | Single file mode: specified file not found or invalid |

```python
from doc4llm.tool.md_doc_extractor import (
    MarkdownDocExtractor,
    BaseDirectoryNotFoundError,
    DocumentNotFoundError,
    InvalidTitleError,
    SingleFileNotFoundError,
)

try:
    extractor = MarkdownDocExtractor(base_dir="invalid_path")
    content = extractor.extract_by_title("Some Title")
except BaseDirectoryNotFoundError as e:
    print(f"Directory not found: {e.base_dir}")
except InvalidTitleError as e:
    print(f"Invalid title: {e.title} - {e.reason}")
except SingleFileNotFoundError as e:
    print(f"File not found: {e.file_path} - {e.reason}")
```

## Import Options

### Import from sub-package (recommended for clarity):

```python
from doc4llm.tool.md_doc_extractor import MarkdownDocExtractor
```

### Import from parent package (backward compatible):

```python
from doc4llm.tool import MarkdownDocExtractor
```

### Import utility functions:

```python
from doc4llm.tool.md_doc_extractor import (
    normalize_title,
    calculate_similarity,
    build_doc_path,
)
```

## Version

Current version: `1.0.0`
