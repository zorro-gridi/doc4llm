# doc-retriever 安全配置指南

## 安全原则

### 1. 最小权限原则
- **只读访问**: 仅允许读取操作，禁止写入和编辑
- **路径限制**: 仅访问 `md_docs/` 目录及其子目录
- **工具限制**: 仅使用必要的工具 (Read, Glob, Grep, Bash)

### 2. 输入验证
- **查询清理**: 过滤恶意查询模式
- **路径验证**: 防止路径遍历攻击
- **命令验证**: 检查 Bash 命令的安全性

### 3. 输出保护
- **AOP 协议**: 确保输出完整性
- **源引用**: 强制包含可验证的源信息
- **内容过滤**: 防止敏感信息泄露

## 安全检查清单

### 部署前检查
- [ ] 所有脚本具有适当的执行权限
- [ ] 日志目录权限配置正确
- [ ] 危险命令模式已被阻止
- [ ] 路径遍历保护已启用
- [ ] 输出格式验证已配置

### 运行时监控
- [ ] 异常访问模式检测
- [ ] 性能异常监控
- [ ] 错误率监控
- [ ] 资源使用监控

## 威胁模型

### 潜在威胁
1. **恶意查询注入**: 通过查询参数执行恶意操作
2. **路径遍历**: 访问 md_docs 外的敏感文件
3. **资源耗尽**: 大量请求导致系统过载
4. **信息泄露**: 意外暴露系统信息

### 缓解措施
1. **输入验证**: 严格的查询和路径验证
2. **权限控制**: 最小权限和沙箱隔离
3. **速率限制**: 防止滥用和过载
4. **输出过滤**: 敏感信息检测和过滤

## 合规要求

### 数据保护
- 不存储用户查询历史（除非明确授权）
- 日志文件定期清理和轮转
- 敏感信息脱敏处理

### 审计要求
- 所有操作记录到审计日志
- 错误和异常事件追踪
- 性能指标收集和分析

## 安全配置示例

### Bash 命令白名单
```bash
# 允许的命令模式
ALLOWED_PATTERNS=(
    "^ls -[la1]+ md_docs/"
    "^find md_docs/ -name"
    "^grep -[rE]+ .* md_docs/"
    "^python .*/extract_md_doc.py"
    "^cat md_docs/.*/doc(Content|TOC).md$"
)
```

### 路径验证
```bash
# 确保路径在允许范围内
validate_path() {
    local path="$1"
    case "$path" in
        md_docs/*) return 0 ;;
        .claude/logs/*) return 0 ;;
        *) return 1 ;;
    esac
}
```

## 事件响应

### 安全事件分类
- **低风险**: 无效查询、轻微权限错误
- **中风险**: 路径遍历尝试、异常访问模式
- **高风险**: 恶意代码注入、系统入侵尝试

### 响应流程
1. **检测**: 自动监控和告警
2. **分析**: 确定事件严重性和影响
3. **响应**: 执行相应的缓解措施
4. **恢复**: 恢复正常服务
5. **总结**: 事后分析和改进

## 定期安全审查

### 月度检查
- 审查访问日志
- 更新威胁模型
- 检查安全配置

### 季度评估
- 渗透测试
- 安全培训
- 政策更新

### 年度审计
- 全面安全评估
- 合规性检查
- 安全架构审查